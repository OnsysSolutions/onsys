generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model TipoStatus {
  id        Int     @id @default(autoincrement())
  nome      String  @unique
  descricao String?

  account        Account[]
  convite        Convite[]
  usuario        Usuario[]
  usuarioAccount UsuarioAccount[]
  dados          Dados[]
}

model TipoUsuario {
  id        Int     @id @default(autoincrement())
  nome      String  @unique
  descricao String?

  usuarios Usuario[]
}

model TipoUsuarioAccount {
  id        Int     @id @default(autoincrement())
  nome      String  @unique
  descricao String?

  convite        Convite[]
  usuarioAccount UsuarioAccount[]
}

model Account {
  id       Int    @id @default(autoincrement())
  nome     String @unique
  image    String @default("conta/default.webp")
  statusId Int    @default(1)

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @default(now()) @updatedAt

  status TipoStatus @relation(fields: [statusId], references: [id])

  convite   Convite[]
  usuarios  UsuarioAccount[]
  historico Historico[]
  dados     Dados[]
}

model Usuario {
  id        Int     @id @default(autoincrement())
  nome      String
  email     String  @unique
  senhaHash String?
  image     String  @default("avatar/default.webp")

  tipoUsuarioId Int @default(2)
  statusId      Int @default(1)

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @default(now()) @updatedAt

  status      TipoStatus  @relation(fields: [statusId], references: [id])
  tipoUsuario TipoUsuario @relation(fields: [tipoUsuarioId], references: [id])

  identities      AuthIdentity[]
  convitesCriados Convite[]        @relation("ConviteCriadoPor")
  convitesAceitos Convite[]        @relation("ConviteUsuario")
  accounts        UsuarioAccount[]
}

model UsuarioAccount {
  podeCriar    Boolean @default(false)
  podeEditar   Boolean @default(false)
  podeDeletar  Boolean @default(false)
  podeConvidar Boolean @default(false)
  podeArquivar Boolean @default(false)

  usuarioId            Int
  accountId            Int
  statusId             Int @default(1)
  tipoUsuarioAccountId Int @default(2)

  account            Account            @relation(fields: [accountId], references: [id])
  status             TipoStatus         @relation(fields: [statusId], references: [id])
  tipoUsuarioAccount TipoUsuarioAccount @relation(fields: [tipoUsuarioAccountId], references: [id])
  usuario            Usuario            @relation(fields: [usuarioId], references: [id])

  historico Historico[]
  dados     Dados[]
  
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @default(now()) @updatedAt

  @@id([usuarioId, accountId])
}

model AuthIdentity {
  id        Int @id @default(autoincrement())
  usuarioId Int

  providerId String
  senhaHash  String?

  provider ProviderType
  usuario  Usuario      @relation(fields: [usuarioId], references: [id])

  criadoEm DateTime @default(now())

  @@unique([provider, providerId])
}

model Dados {
  id        Int     @id @default(autoincrement())
  titulo    String
  descricao String?
  conteudo  String?

  statusId  Int @default(1)
  accountId Int
  usuarioId Int

  status         TipoStatus     @relation(fields: [statusId], references: [id])
  account        Account        @relation(fields: [accountId], references: [id])
  usuarioAccount UsuarioAccount @relation(fields: [usuarioId, accountId], references: [usuarioId, accountId])

  historico Historico[]

  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @default(now()) @updatedAt

  @@unique([titulo, accountId]) // <-- chave Ãºnica composta para upsert
}

model Historico {
  id        Int      @id @default(autoincrement())
  acao      Acao     @default(CRIADO)
  descricao String?
  criadoEm  DateTime @default(now())

  accountId Int?
  usuarioId Int?
  dadoId    Int?
  conviteId Int?

  account        Account?        @relation(fields: [accountId], references: [id])
  usuarioAccount UsuarioAccount? @relation(fields: [usuarioId, accountId], references: [usuarioId, accountId])
  dado           Dados?          @relation(fields: [dadoId], references: [id])
  convite        Convite?        @relation(fields: [conviteId], references: [id])
}

model Convite {
  id        Int       @id @default(autoincrement())
  email     String
  token     String    @unique
  aceito    Boolean   @default(false)
  expiracao DateTime?
  mensagem  String?

  criadoEm DateTime @default(now())

  tipoStatusid  Int  @default(1)
  tipoUsuarioId Int
  criadoPorId   Int
  accountId     Int
  usuarioId     Int?

  account     Account            @relation(fields: [accountId], references: [id])
  criadoPor   Usuario            @relation("ConviteCriadoPor", fields: [criadoPorId], references: [id])
  tipoStatus  TipoStatus         @relation(fields: [tipoStatusid], references: [id])
  tipoUsuario TipoUsuarioAccount @relation(fields: [tipoUsuarioId], references: [id])
  usuario     Usuario?           @relation("ConviteUsuario", fields: [usuarioId], references: [id])

  historico Historico[]
}

model EmailVerification {
  id         Int      @id @default(autoincrement())
  email      String
  codigo     String
  expiracao  DateTime
  verificado Boolean  @default(false)

  criadoEm DateTime  @default(now())
  usadoEm  DateTime?
}

enum Acao {
  CRIADO
  EDITADO
  ARQUIVADO
  DESCARTADO
  MOVIMENTADO
  REENVIADO
}

enum ProviderType {
  EMAIL
  GOOGLE
  FACEBOOK
}
